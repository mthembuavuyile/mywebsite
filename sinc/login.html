<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SINC â€” Login or Sign Up</title>
    <meta name="description" content="Login or Sign Up for the SINC Dashboard." />
    <meta name="author" content="Avuyile Mthembu" />
    <meta name="keywords" content="SINC, Login, Signup, Legal, Law, Sethu Mkhwanazi, Avuyile Mthembu" />
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <link rel="preconnect" href="https://rsms.me/" />
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />
    <style>
        @import url('https://rsms.me/inter/inter.css');
        html { font-family: 'Inter', sans-serif; }
        @supports (font-variation-settings: normal) { html { font-family: 'Inter var', sans-serif; } }
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        /* Add a style for the disabled button */
        button:disabled {
            cursor: not-allowed;
            background-color: #a5b4fc; /* Lighter shade of the button color */
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- AUTHENTICATION CONTAINER -->
    <div id="auth-container" class="min-h-screen flex items-center justify-center bg-gray-50 py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div>
                <h1 class="text-center text-4xl font-bold text-sky-800">SINC</h1>
                <h2 id="auth-title" class="mt-2 text-center text-xl text-gray-900">Sign in to your account</h2>
            </div>

            <!-- A single, shared message area for info/success -->
            <p id="info-message" class="text-sm text-green-700 bg-green-100 border border-green-200 p-3 rounded-md mt-2 text-center hidden"></p>

            <!-- Login Form -->
            <form id="login-form" class="mt-8 space-y-6">
                <div class="rounded-md shadow-sm -space-y-px">
                    <input id="login-email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-sky-500 focus:border-sky-500 focus:z-10 sm:text-sm" placeholder="Email address">
                    <div class="relative">
                        <input id="login-password" type="password" autocomplete="current-password" required class="appearance-none rounded-none block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-sky-500 focus:border-sky-500 focus:z-10 sm:text-sm pr-10" placeholder="Password">
                        <button type="button" id="toggle-login-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600 focus:outline-none" aria-label="Toggle password visibility">
                            <svg id="eye-open-login" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            <svg id="eye-closed-login" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .946-3.003 3.38-5.405 6.386-6.236M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 2l20 20" /></svg>
                        </button>
                    </div>
                </div>
                <div class="flex items-center justify-end">
                    <div class="text-sm">
                        <a href="#" id="forgot-password-link" class="font-medium text-sky-600 hover:text-sky-500"> Forgot your password? </a>
                    </div>
                </div>
                <p id="login-error" class="text-sm text-red-600 mt-2 text-center hidden"></p>
                <button type="submit" id="login-submit-button" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-sky-700 hover:bg-sky-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">Sign in</button>
            </form>

            <!-- Signup Form (hidden by default) -->
            <form id="signup-form" class="mt-8 space-y-4 hidden">
                 <div class="rounded-md shadow-sm -space-y-px">
                    <input id="signup-name" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-sky-500 focus:border-sky-500 focus:z-10 sm:text-sm" placeholder="Your Name">
                    <input id="signup-email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-sky-500 focus:border-sky-500 focus:z-10 sm:text-sm" placeholder="Email address">
                    <div class="relative">
                        <input id="signup-password" type="password" autocomplete="new-password" required class="appearance-none rounded-none block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-sky-500 focus:border-sky-500 focus:z-10 sm:text-sm pr-10" placeholder="Password">
                         <button type="button" id="toggle-signup-password" class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600 focus:outline-none" aria-label="Toggle password visibility">
                            <svg id="eye-open-signup" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            <svg id="eye-closed-signup" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.542-7 .946-3.003 3.38-5.405 6.386-6.236M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2 2l20 20" /></svg>
                        </button>
                    </div>
                </div>
                 <div class="text-xs text-gray-600 space-y-1 pl-1">
                    <p class="font-medium">Password must contain at least:</p>
                    <ul class="list-disc list-inside ml-2">
                        <li>6 characters</li>
                        <li>One uppercase letter (A-Z)</li>
                        <li>One lowercase letter (a-z)</li>
                        <li>One special character (e.g., !@#$%)</li>
                    </ul>
                </div>
                <p id="signup-error" class="text-sm text-red-600 mt-2 text-center hidden"></p>
                <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-sky-700 hover:bg-sky-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">Create Account</button>
            </form>
            
            <!-- Password Reset Form -->
            <form id="password-reset-form" class="mt-8 space-y-6 hidden">
                <p class="text-center text-sm text-gray-600">Enter your email and we'll send you a link to reset your password.</p>
                <div class="rounded-md shadow-sm">
                    <input id="reset-email" type="email" autocomplete="email" required class="appearance-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-sky-500 focus:border-sky-500 sm:text-sm" placeholder="Email address">
                </div>
                <p id="reset-error" class="text-sm text-red-600 mt-2 text-center hidden"></p>
                <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-sky-700 hover:bg-sky-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-sky-500">Send Reset Link</button>
            </form>

            <div class="mt-6">
                <div class="relative">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-gray-300"></div></div>
                    <div class="relative flex justify-center text-sm"><span class="px-2 bg-gray-50 text-gray-500">Or continue with</span></div>
                </div>
                <div class="mt-6">
                    <button id="google-signin-button" class="w-full inline-flex justify-center py-2 px-4 border border-gray-300 rounded-md shadow-sm bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                        <span class="sr-only">Sign in with Google</span>
                        <svg class="w-5 h-5" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 0C4.477 0 0 4.477 0 10s4.477 10 10 10 10-4.477 10-10S15.523 0 10 0zM8.28 15.232c-2.35-1.42-3.83-3.98-3.83-6.852h7.66c0-3.34-2.72-6.06-6.06-6.06-3.34 0-6.06 2.72-6.06 6.06s2.72 6.06 6.06 6.06c1.56 0 2.98-.6 4.07-1.58l-1.42-1.42c-.6.48-1.38.77-2.23.77a3.83 3.83 0 0 1-3.83-3.83H10v-1.9H4.17c.06-1.56.6-3.02 1.58-4.24l-1.42-1.42A6.03 6.03 0 0 0 2.34 10c0 3.34 2.72 6.06 6.06 6.06 2.05 0 3.87-.99 5.02-2.58l-1.42-1.42c-.75 1.14-2.02 1.9-3.45 1.9z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
            <div id="auth-switch-container" class="text-center mt-2 text-sm text-gray-600">
                <p id="show-signup-container">
                    Don't have an account? <button id="show-signup-form" class="font-medium text-sky-600 hover:text-sky-500">Create one</button>
                </p>
                <p id="show-login-container" class="hidden">
                    Already have an account? <button id="show-login-form" class="font-medium text-sky-600 hover:text-sky-500">Sign in</button>
                </p>
            </div>

            <div class="text-center text-sm text-gray-500 pt-6 border-t border-gray-200">
            Powered by 
            <a href="https://sethumkhwanaziattorneys.co.za/" target="_blank" rel="noopener noreferrer" class="text-sky-600 hover:text-sky-800 font-medium">
                Sethu Mkhwanazi Attorneys
            </a>
            </div>
        </div>
    </div>


<script type="module">
    // --- FIREBASE SDK IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, sendPasswordResetEmail, sendEmailVerification, signOut } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
        apiKey: "AIzaSyCqBlHjmayoGIvlLJD58yR6phsHzLtjAH4", // Use environment variables in production
        authDomain: "sinc-c6b24.firebaseapp.com",
        projectId: "sinc-c6b24",
        storageBucket: "sinc-c6b24.appspot.com",
        messagingSenderId: "547513001470",
        appId: "1:547513001470:web:7c37b34318c0ee0709ccaf",
    };

    // --- FIREBASE INITIALIZATION ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();

    // --- DOM ELEMENTS ---
    const authTitleEl = document.getElementById('auth-title');
    const loginFormEl = document.getElementById('login-form');
    const signupFormEl = document.getElementById('signup-form');
    const passwordResetFormEl = document.getElementById('password-reset-form');
    const showLoginContainerEl = document.getElementById('show-login-container');
    const showSignupContainerEl = document.getElementById('show-signup-container');
    const infoMessageEl = document.getElementById('info-message');
    const loginErrorEl = document.getElementById('login-error');
    const signupErrorEl = document.getElementById('signup-error');
    const resetErrorEl = document.getElementById('reset-error');
    const loginSubmitButton = document.getElementById('login-submit-button');

    // --- FRONTEND RATE LIMITER (Exponential Backoff) ---
    const RateLimiter = {
        ATTEMPT_KEY: 'login_attempts',
        LOCKOUT_KEY: 'login_lockout_until',
        ATTEMPTS_BEFORE_LOCKOUT: 3,

        check: function() {
            const lockoutUntil = parseInt(localStorage.getItem(this.LOCKOUT_KEY) || '0');
            if (Date.now() < lockoutUntil) {
                const remainingSeconds = Math.ceil((lockoutUntil - Date.now()) / 1000);
                const message = `Too many failed attempts. Please wait ${remainingSeconds}s.`;
                showError(loginErrorEl, message);
                this.disableLoginButton(remainingSeconds);
                return true; // Is locked
            }
            return false; // Is not locked
        },
        
        recordFailure: function() {
            let attempts = parseInt(localStorage.getItem(this.ATTEMPT_KEY) || '0') + 1;
            localStorage.setItem(this.ATTEMPT_KEY, attempts);

            if (attempts % this.ATTEMPTS_BEFORE_LOCKOUT === 0) {
                const lockoutRound = attempts / this.ATTEMPTS_BEFORE_LOCKOUT;
                const delaySeconds = 10 * Math.pow(2, lockoutRound - 1);
                const lockoutUntil = Date.now() + delaySeconds * 1000;
                localStorage.setItem(this.LOCKOUT_KEY, lockoutUntil);
                this.disableLoginButton(delaySeconds);
            }
        },

        recordSuccess: function() {
            localStorage.removeItem(this.ATTEMPT_KEY);
            localStorage.removeItem(this.LOCKOUT_KEY);
        },
        
        disableLoginButton: function(seconds) {
            loginSubmitButton.disabled = true;
            let countdown = seconds;
            loginSubmitButton.textContent = `Try again in ${countdown}s`;
            
            const interval = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    loginSubmitButton.textContent = `Try again in ${countdown}s`;
                } else {
                    clearInterval(interval);
                    loginSubmitButton.disabled = false;
                    loginSubmitButton.textContent = 'Sign in';
                    hideMessage(loginErrorEl);
                }
            }, 1000);
        }
    };

    // --- AUTH STATE OBSERVER ---
    onAuthStateChanged(auth, user => {
        if (user && user.emailVerified) {
            console.log("âœ… Verified user logged in, redirecting to dashboard...");
            window.location.href = 'dashboard.html'; // Or your target page
        } else {
            // This case covers: No user, or a user who just signed up/failed login
            // and has been signed out. We ensure the UI is visible.
            console.log("ðŸ‘¤ No authenticated user session active. Showing auth page.");
            document.body.style.display = 'block'; 
        }
    });

    // Hide body initially to prevent flash of unstyled content if user is logged in
    document.body.style.display = 'none';

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        // Initial check for rate limit on page load
        RateLimiter.check();

        signupFormEl.addEventListener('submit', handleSignup);
        loginFormEl.addEventListener('submit', handleLogin);
        passwordResetFormEl.addEventListener('submit', handlePasswordReset);
        
        document.getElementById('google-signin-button').addEventListener('click', handleGoogleSignIn);
        document.getElementById('show-signup-form').addEventListener('click', () => switchAuthView('signup'));
        document.getElementById('show-login-form').addEventListener('click', (e) => {
            e.preventDefault();
            switchAuthView('login');
        });
        document.getElementById('forgot-password-link').addEventListener('click', (e) => {
            e.preventDefault();
            switchAuthView('reset');
        });

        // Password visibility toggles
        document.getElementById('toggle-login-password').addEventListener('click', () => togglePasswordVisibility('login-password', 'eye-open-login', 'eye-closed-login'));
        document.getElementById('toggle-signup-password').addEventListener('click', () => togglePasswordVisibility('signup-password', 'eye-open-signup', 'eye-closed-signup'));
    });

    // --- HANDLER FUNCTIONS ---
    async function handleSignup(e) {
        e.preventDefault();
        const name = signupFormEl.querySelector('#signup-name').value;
        const email = signupFormEl.querySelector('#signup-email').value;
        const password = signupFormEl.querySelector('#signup-password').value;
        
        clearAllMessages();

        const passwordError = validatePassword(password);
        if (passwordError) {
            showError(signupErrorEl, passwordError);
            return;
        }

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            await sendEmailVerification(user);
            await setDoc(doc(db, "users", user.uid), { name, email, createdAt: new Date() });
            
            // Critical step: Sign out to force email verification before first login
            await signOut(auth);

            // 1. First-time signup: Switch to login and show verification message
            switchAuthView('login');
            showInfo("Please check your email and click the verification link to activate your account. Don't forget to check your spam folder.");

        } catch (error) {
            // 2. Email already exists
            showError(signupErrorEl, mapFirebaseErrorToMessage(error));
        }
    }

    async function handleLogin(e) {
        e.preventDefault();
        clearAllMessages();

        if (RateLimiter.check()) {
            return;
        }

        const email = loginFormEl.querySelector('#login-email').value;
        const password = loginFormEl.querySelector('#login-password').value;

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            if (!user.emailVerified) {
                // 3. Email verification (on login attempt)
                await sendEmailVerification(user);
                await signOut(auth);
                showInfo("Your email hasn't been verified yet. A new verification email has been sent. Please check your email (and spam folder) and click the link to verify your account.");
                return;
            }
            
            // On successful login, reset the rate limiter
            RateLimiter.recordSuccess();
            // The onAuthStateChanged observer will handle the successful redirect.

        } catch (error) {
            // 2. Incorrect email or password
            RateLimiter.recordFailure(); // Record the failed attempt
            showError(loginErrorEl, mapFirebaseErrorToMessage(error));
        }
    }

    async function handlePasswordReset(e) {
        e.preventDefault();
        clearAllMessages();
        const email = passwordResetFormEl.querySelector('#reset-email').value;

        try {
            await sendPasswordResetEmail(auth, email);
            // 1 & 2. Existing and Non-existent email
            switchAuthView('login'); // Switch back to login for better UX
            showInfo("If this email is associated with an account, a password reset link will be sent. Please check your email (and spam folder).");
        } catch(error) {
            // This usually only catches `auth/invalid-email`
            showError(resetErrorEl, mapFirebaseErrorToMessage(error));
        }
    }

    async function handleGoogleSignIn() {
        clearAllMessages();
        try {
            await signInWithPopup(auth, googleProvider);
            // The onAuthStateChanged will handle the successful redirect.
            // Google-verified emails are considered trusted, so no extra check is needed.
        } catch (error) {
            showError(loginErrorEl, mapFirebaseErrorToMessage(error));
        }
    }

    // --- HELPER FUNCTIONS ---

    function mapFirebaseErrorToMessage(error) {
        console.error("Firebase Auth Error:", error.code, error.message);
        switch (error.code) {
            case 'auth/email-already-in-use':
                return "This email is already registered. Please sign in or use 'Forgot your password?'.";
            case 'auth/invalid-email':
                return 'Please enter a valid email address.';
            case 'auth/user-not-found':
            case 'auth/wrong-password':
            case 'auth/invalid-credential':
                return "Incorrect email or password. Please try again.";
            case 'auth/weak-password':
                return 'The password is too weak. Please choose a stronger one.';
            case 'auth/user-disabled':
                 return "Your account has been suspended. Please contact support for assistance.";
            default:
                return 'An unexpected error occurred. Please try again later.';
        }
    }

    function validatePassword(password) {
        if (password.length < 6) return "Password must be at least 6 characters.";
        if (!/[A-Z]/.test(password)) return "Password must contain at least one uppercase letter.";
        if (!/[a-z]/.test(password)) return "Password must contain at least one lowercase letter.";
        if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) return "Password must contain at least one special character.";
        return null; 
    }

    function togglePasswordVisibility(inputId, openEyeId, closedEyeId) {
        const passwordInput = document.getElementById(inputId);
        const eyeOpen = document.getElementById(openEyeId);
        const eyeClosed = document.getElementById(closedEyeId);
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            eyeOpen.classList.add('hidden');
            eyeClosed.classList.remove('hidden');
        } else {
            passwordInput.type = 'password';
            eyeOpen.classList.remove('hidden');
            eyeClosed.classList.add('hidden');
        }
    }

    function switchAuthView(view) {
        clearAllMessages();
        loginFormEl.classList.add('hidden');
        signupFormEl.classList.add('hidden');
        passwordResetFormEl.classList.add('hidden');
        
        switch (view) {
            case 'signup':
                signupFormEl.classList.remove('hidden');
                authTitleEl.textContent = "Create an Account";
                showLoginContainerEl.classList.remove('hidden');
                showSignupContainerEl.classList.add('hidden');
                break;
            case 'reset':
                passwordResetFormEl.classList.remove('hidden');
                authTitleEl.textContent = "Reset Your Password";
                showLoginContainerEl.classList.remove('hidden');
                showSignupContainerEl.classList.add('hidden');
                break;
            default: // 'login'
                loginFormEl.classList.remove('hidden');
                authTitleEl.textContent = "Sign in to Your Account";
                showLoginContainerEl.classList.add('hidden');
                showSignupContainerEl.classList.remove('hidden');
                break;
        }
    }
    
    function showError(element, message) {
        element.textContent = message;
        element.classList.remove('hidden');
    }

    function showInfo(message) {
        infoMessageEl.textContent = message;
        infoMessageEl.classList.remove('hidden');
    }
    
    function hideMessage(element) {
        if(element) {
            element.textContent = '';
            element.classList.add('hidden');
        }
    }
    
    function clearAllMessages() {
        hideMessage(infoMessageEl);
        hideMessage(loginErrorEl);
        hideMessage(signupErrorEl);
        hideMessage(resetErrorEl);
    }
</script>
</body>
</html>
