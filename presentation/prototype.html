<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Nexora - Your Digital Campus</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸŽ“</text></svg>">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            'primary': { DEFAULT: '#4A55E7', light: '#6875F5', dark: '#3B47D9', contrast: '#ffffff' },
            'secondary': { DEFAULT: '#F59E0B', contrast: '#1E293B' },
            'accent': { DEFAULT: '#10B981', contrast: '#ffffff' },
            'neutral': {
              50: '#F8FAFC', 100: '#F1F5F9', 200: '#E2E8F0', 300: '#CBD5E1', 400: '#94A3B8',
              500: '#64748B', 600: '#475569', 700: '#334155', 800: '#1E293B', 900: '#0F172A'
            },
            'danger': '#EF4444', 'success': '#22C55E', 'warning': '#F59E0B',
          },
          backgroundImage: {
            'primary-gradient': 'linear-gradient(135deg, #4A55E7, #6875F5)',
            'login-gradient': 'linear-gradient(135deg, #0F172A, #1E293B)',
            'card-gradient': 'linear-gradient(145deg, #4A55E7, #3B47D9)',
          },
          boxShadow: {
            'interactive': '0 0 0 4px rgba(74, 85, 231, 0.2)',
            'card': '0 4px 12px rgba(0, 0, 0, 0.05)',
            'card-hover': '0 10px 25px rgba(74, 85, 231, 0.1)',
          },
          keyframes: {
            fadeInUp: { from: { opacity: '0', transform: 'translateY(15px)' }, to: { opacity: '1', transform: 'translateY(0)' } },
            pulseGlow: { '50%': { boxShadow: '0 0 0 4px rgba(74, 85, 231, 0.4)' } }
          },
          animation: {
            'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
            'pulse-glow': 'pulseGlow 2s ease-in-out infinite'
          }
        }
      }
    }
  </script>

  <style>
    html { scroll-behavior: smooth; }
    body {
      background-color: #F8FAFC; /* neutral-50 */
      font-family: 'Inter', sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    body.modal-open { overflow: hidden; }
    .view-content { animation: fadeInUp 0.5s ease-out forwards; }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #E2E8F0; } /* neutral-200 */
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #94A3B8; border-radius: 3px; } /* neutral-400 */
    
    /* Modal Transitions */
    .modal-container { pointer-events: none; opacity: 0; transition: opacity 0.25s ease; }
    .modal-container.is-open { pointer-events: auto; opacity: 1; }
    .modal-content { transform: scale(0.95); transition: transform 0.25s ease; }
    .modal-container.is-open .modal-content { transform: scale(1); }

    /* Custom form styling */
    .form-input {
      display: block; width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #CBD5E1; /* neutral-300 */
      border-radius: 0.5rem; /* rounded-lg */
      background-color: white;
      color: #0F172A; /* neutral-900 */
      transition: all 0.2s ease;
    }
    .form-input:focus {
      outline: 2px solid transparent;
      outline-offset: 2px;
      border-color: #4A55E7; /* primary */
      box-shadow: 0 0 0 2px rgba(74, 85, 231, 0.3);
    }
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500; /* font-medium */
      color: #334155; /* neutral-700 */
    }
  </style>
</head>
<body class="text-neutral-800">
  <div id="app"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- STATE & DATA ---
      const state = {
        user: null,
        activeView: 'dashboard',
        modals: { 
          aiChat: false,
          profilePersonal: false,
          profileAcademic: false,
          profileDocuments: false,
        },
        
        universalProfile: { 
          personal: 20, academic: 0, documents: 0, 
          get totalCompletion() { return Math.round((this.personal + this.academic + this.documents) / 3); },
          data: {
            personal: { fullName: "Avuyile Mthembu", idNumber: "9901011234083", phone: "0821234567" },
            academic: { school: "", grade11Avg: "", grade12Avg: "" },
            documents: { id: null, proof: null }
          }
        },
        myApplications: [
          { id: 'app1', name: 'University of Cape Town', progress: 75, status: 'Awaiting Documents', nextStep: 'Upload Final Matric Results' },
          { id: 'app2', name: 'Wits University', progress: 100, status: 'Accepted', nextStep: 'Accept or Decline Offer' },
          { id: 'app3', name: 'NSFAS Funding', progress: 50, status: 'Submitted', nextStep: 'Awaiting Assessment' }
        ],
        myChecklist: [
          { id: 'c1', text: 'Complete Your Universal Profile', done: false, action: 'navigate:profile' },
          { id: 'c2', text: 'Shortlist 3 Funding Opportunities', done: true, action: 'navigate:funding' },
          { id: 'c3', text: 'Upload Certified ID Document', done: false, action: 'open-modal:profileDocuments' }
        ],
        shortlist: { institutions: new Set(['inst1']), funding: new Set(['fund3']) },
        aiChat: { messages: [], isLoading: false },
        qrCodeValue: `NEXORA-ID-ST12345678-${Date.now()}`
      };

      const appContainer = document.getElementById('app');

      const constants = {
        navItems: [
          { id: 'dashboard', label: 'Dashboard', icon: 'fa-solid fa-house' },
          { id: 'digital-id', label: 'Digital ID', icon: 'fa-solid fa-id-card' },
          { id: 'campus-hub', label: 'Campus Hub', icon: 'fa-solid fa-users' },
          { id: 'profile', label: 'Universal Profile', icon: 'fa-solid fa-user-pen' },
          { id: 'apply', label: 'Institutions', icon: 'fa-solid fa-building-columns' },
          { id: 'funding', label: 'Funding', icon: 'fa-solid fa-sack-dollar' },
          { id: 'shortlist', label: 'My Shortlist', icon: 'fa-solid fa-star' },
        ],
        allInstitutions: [
          { id: "inst1", name: "University of Cape Town", shortName: "UCT", location: "Western Cape", type: "Public University", logo: "building-columns" },
          { id: "inst2", name: "University of the Witwatersrand", shortName: "Wits", location: "Gauteng", type: "Public University", logo: "landmark" },
          { id: "inst3", name: "Stellenbosch University", shortName: "Stellies", location: "Western Cape", type: "Public University", logo: "building-columns" },
          { id: "inst4", name: "University of KwaZulu-Natal", shortName: "UKZN", location: "KwaZulu-Natal", type: "Public University", logo: "landmark" },
          { id: "inst5", name: "Tshwane University of Technology", shortName: "TUT", location: "Gauteng", type: "TVET College", logo: "university" },
          { id: "inst6", name: "False Bay TVET College", shortName: "False Bay", location: "Western Cape", type: "TVET College", logo: "university" },
        ],
        fundingOpportunities: [
          { id: "fund3", name: "Vodacom Bursary", provider: "Vodacom", type: "Bursary", status: "Open", value: "Full tuition, books, accommodation", eligibility: "Under 25, 70%+ avg in STEM fields", closingDate: "2025-08-31" },
          { id: "fund1", name: "NSFAS Funding", provider: "DHET", type: "Grant", status: "Open", value: "Full Cost of Study", eligibility: "SA Citizen, income < R350k/yr", closingDate: "2025-11-30" },
          { id: "fund2", name: "Sasol Foundation Bursary", provider: "Sasol", type: "Bursary", status: "Closing Soon", value: "Full tuition, meals, accommodation", eligibility: "SA Citizen, STEM fields", closingDate: "2025-07-30" },
          { id: "fund4", name: "FirstRand Foundation Scholarship", provider: "FirstRand", type: "Scholarship", status: "Closed", value: "Postgraduate studies", eligibility: "Academic excellence", closingDate: "2025-03-01" },
        ],
        campusHub: {
            courses: [
                { id: 'cos101', name: 'Computer Science 101', code: 'COS101', unread: 3 },
                { id: 'mat101', name: 'Mathematics for Engineers', code: 'MAT101', unread: 0 },
                { id: 'phy101', name: 'Physics & Mechanics', code: 'PHY101', unread: 1 },
            ],
            studyGroups: [
                { id: 'sg1', name: 'COS101 Exam Prep', members: 8, capacity: 15 },
                { id: 'sg2', name: 'Weekly Physics Problems', members: 4, capacity: 10 },
            ],
            mentors: [
                { id: 'm1', name: 'Jane Doe', field: 'Final Year CompSci', available: true },
                { id: 'm2', name: 'John Smith', field: 'Engineering Alumni', available: false },
            ]
        },
      };

      // --- UI COMPONENTS ---
      const createIcon = (name, className = '') => `<i class="${name} ${className}"></i>`;
      const createTag = (text, colorKey = 'primary', size = 'sm') => {
        const colors = { primary: 'bg-primary/10 text-primary', accent: 'bg-accent/10 text-accent', success: 'bg-success/10 text-success', danger: 'bg-danger/10 text-danger', warning: 'bg-warning/10 text-warning-contrast', secondary: 'bg-secondary/10 text-secondary-contrast', neutral: 'bg-neutral-200 text-neutral-600' };
        const sizes = { sm: 'px-2.5 py-1 text-xs', md: 'px-3 py-1.5 text-sm' };
        return `<span class="inline-block rounded-full font-semibold uppercase tracking-wider ${sizes[size]} ${colors[colorKey] || colors.primary}">${text}</span>`;
      };
      const createButton = ({ text, variant = 'primary', size = 'md', className = '', iconLeft = '', iconRight = '', action = '', disabled = false }) => {
        const base = 'inline-flex items-center justify-center font-semibold rounded-lg focus:outline-none focus:ring-4 transition-all duration-200 disabled:opacity-60 disabled:cursor-not-allowed active:scale-[0.98]';
        const variants = { primary: 'bg-primary-gradient text-primary-contrast hover:shadow-lg focus:ring-primary/30 shadow-md', secondary: 'bg-neutral-50 text-neutral-800 border-2 border-neutral-200 hover:border-primary focus:ring-primary/30', ghost: 'bg-transparent text-neutral-600 hover:bg-neutral-100 hover:text-primary focus:ring-primary/30' };
        const sizes = { sm: 'px-3 py-2 text-sm', md: 'px-5 py-2.5 text-base', lg: 'px-7 py-3 text-lg' };
        return `<button ${disabled ? 'disabled' : ''} class="${base} ${variants[variant]} ${sizes[size]} ${className}" data-action="${action}">
          ${iconLeft ? createIcon(iconLeft, 'mr-2') : ''}${text}${iconRight ? createIcon(iconRight, 'ml-2') : ''}
        </button>`;
      };
      const createProgressBar = (value, className = '') => `<div class="w-full bg-neutral-200 rounded-full h-2.5 ${className}"><div class="bg-primary h-2.5 rounded-full transition-all duration-500" style="width: ${Math.max(0, Math.min(100, value))}%"></div></div>`;
      const createEmptyState = (icon, title, text) => `<div class="text-center p-12 bg-neutral-100 rounded-2xl border-2 border-dashed border-neutral-200 col-span-full"><h3 class="text-xl font-bold text-neutral-800">${title}</h3><p class="text-base text-neutral-500 mt-2">${text}</p></div>`;
      
      const createViewHeader = (title, subtitle, actionsHTML = '') => `
        <div class="flex flex-col md:flex-row justify-between md:items-start mb-8">
          <div>
            <h1 class="text-3xl md:text-4xl font-extrabold text-neutral-900 tracking-tight">${title}</h1>
            <p class="text-lg text-neutral-500 mt-2">${subtitle}</p>
          </div>
          ${actionsHTML ? `<div class="flex-shrink-0 mt-4 md:mt-0">${actionsHTML}</div>` : ''}
        </div>`;
      
      const createSearchFilterHeader = (type) => {
        const placeholders = { institutions: 'Search by name or location...', funding: 'Search by name or provider...' };
        const filters = { institutions: ['Type', 'Location'], funding: ['Type', 'Field of Study'] };
        return `
          <div class="flex flex-col md:flex-row gap-3 mb-6 p-4 bg-white rounded-xl shadow-card border border-neutral-200">
            <input type="search" placeholder="${placeholders[type]}" class="form-input flex-grow">
            <div class="flex-shrink-0 flex gap-2">
              ${filters[type].map(f => createButton({ text: f, variant: 'secondary', size: 'sm', iconRight: 'fa-solid fa-chevron-down' })).join('')}
            </div>
          </div>`;
      };

      // --- VIEWS ---
      const renderLoginView = () => `
        <div class="min-h-screen flex items-center justify-center bg-login-gradient p-4">
          <div class="w-full max-w-md animation-fade-in-up">
            <div class="bg-neutral-800/50 backdrop-blur-lg p-8 md:p-10 rounded-2xl shadow-xl border border-neutral-700">
              <div class="text-center mb-8">
                <h1 class="text-5xl font-extrabold text-white">Nexora<span class="text-primary-light">.</span></h1>
                <p class="text-neutral-300 text-lg mt-2">Your Digital Campus, Unified.</p>
              </div>
              <form id="login-form" class="space-y-5">
                  <div>
                   <label for="email" class="block text-sm font-medium text-neutral-200 mb-1.5">University Email</label>
                   <input type="email" id="email" value="student@myunisa.ac.za" required class="w-full px-4 py-3 border border-neutral-600 rounded-xl bg-neutral-900 text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary transition text-base shadow-sm"/>
                  </div>
                  <div class="pt-3">
                   <button type="submit" class="w-full text-lg px-7 py-3 inline-flex items-center justify-center font-semibold rounded-lg focus:outline-none focus:ring-4 transition-all duration-200 active:scale-[0.98] bg-primary-gradient text-primary-contrast hover:shadow-lg focus:ring-primary/30 shadow-md">
                     Sign In Securely
                   </button>
                  </div>
              </form>
            </div>
          </div>
        </div>`;

      const renderDashboardView = () => `
        ${createViewHeader(`Welcome, ${state.user.name.split(' ')[0]}!`, "Here's a snapshot of your journey.")}
        <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
          <div class="lg:col-span-3 space-y-6">
            <div class="bg-primary-dark p-8 rounded-2xl shadow-xl text-white bg-login-gradient">
              <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold">Universal Application</h2>
                <span class="text-4xl font-extrabold">${state.universalProfile.totalCompletion}%</span>
              </div>
              <p class="mt-2 mb-4 opacity-80">Complete your profile to apply to multiple places with one click.</p>
              ${createProgressBar(state.universalProfile.totalCompletion)}
              <div class="mt-6">${createButton({ text: 'Complete Your Profile', action: 'navigate:profile', size: 'sm', variant: 'secondary', iconRight:'fa-solid fa-arrow-right' })}</div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-card border border-neutral-200">
              <h2 class="text-xl font-bold text-neutral-800 mb-5">My Applications</h2>
              <ul class="space-y-5">
                ${state.myApplications.map(app => `
                  <li>
                    <div class="flex justify-between items-center mb-2">
                      <span class="font-semibold text-neutral-700">${app.name}</span>
                      ${createTag(app.status, { 'Accepted': 'success', 'Awaiting Documents': 'warning', 'Submitted': 'neutral' }[app.status])}
                    </div>
                    ${createProgressBar(app.progress, 'mb-2')}
                    <p class="text-sm text-neutral-500"><strong>Next Step:</strong> ${app.nextStep}</p>
                  </li>
                `).join('')}
              </ul>
            </div>
          </div>
          <div class="lg:col-span-2 space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-card border border-neutral-200">
              <h2 class="text-xl font-bold text-neutral-800 mb-4">Quick Actions</h2>
              <div class="space-y-3">
                ${createButton({ text: 'View Digital ID', action: 'navigate:digital-id', variant: 'secondary', size: 'sm', className:'w-full !justify-start', iconLeft: 'fa-solid fa-id-card' })}
                ${createButton({ text: 'Go to Campus Hub', action: 'navigate:campus-hub', variant: 'secondary', size: 'sm', className:'w-full !justify-start', iconLeft: 'fa-solid fa-users' })}
                ${createButton({ text: 'Ask AI Advisor', action: 'open-modal:aiChat', variant: 'secondary', size: 'sm', className:'w-full !justify-start animate-pulse-glow', iconLeft: 'fa-solid fa-robot' })}
              </div>
            </div>
            
            <div class="bg-white p-6 rounded-2xl shadow-card border border-neutral-200">
              <h2 class="text-xl font-bold text-neutral-800 mb-4">Your Checklist</h2>
              <ul class="space-y-3">
                ${state.myChecklist.map(item => `
                  <li data-action="${item.action}" class="flex items-center p-2 -m-2 rounded-lg hover:bg-neutral-100 cursor-pointer">
                    <div class="w-5 h-5 flex items-center justify-center rounded-full mr-3 ${item.done ? 'bg-success text-white' : 'bg-neutral-200 text-neutral-500'}">
                      ${createIcon(item.done ? 'fa-solid fa-check fa-xs' : 'fa-regular fa-circle fa-xs')}
                    </div>
                    <span class="${item.done ? 'line-through text-neutral-500' : 'font-medium text-neutral-700'}">${item.text}</span>
                  </li>
                `).join('')}
              </ul>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-card border border-neutral-200">
              <h2 class="text-xl font-bold text-neutral-800 mb-4">My Shortlist</h2>
              <div class="flex space-x-6 text-center">
                <div class="flex-1"><p class="text-3xl font-bold text-primary">${state.shortlist.institutions.size}</p><p class="text-sm text-neutral-500 font-medium">Institutions</p></div>
                <div class="flex-1"><p class="text-3xl font-bold text-accent">${state.shortlist.funding.size}</p><p class="text-sm text-neutral-500 font-medium">Funding Options</p></div>
              </div>
            </div>
          </div>
        </div>
      `;

      // --- NEW: SA STUDENT PASS / DIGITAL ID VIEW ---
      const renderDigitalIdView = () => `
        ${createViewHeader('SA Student Pass', 'Your secure, unified digital identity for campus life.')}
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2">
                <div class="bg-card-gradient text-white p-8 rounded-2xl shadow-2xl relative overflow-hidden">
                    <div class="absolute -top-10 -right-10 w-40 h-40 bg-white/10 rounded-full"></div>
                    <div class="absolute -bottom-12 -left-8 w-32 h-32 bg-white/10 rounded-full"></div>
                    <div class="relative z-10">
                        <div class="flex items-start justify-between mb-6">
                            <div>
                                <h2 class="text-2xl font-bold tracking-tight">${state.user.name}</h2>
                                <p class="text-base opacity-80">${state.user.university}</p>
                                <p class="text-sm opacity-60">Student No: ${state.user.studentNumber}</p>
                            </div>
                            <img src="https://i.pravatar.cc/80?u=${state.user.email}" class="w-20 h-20 rounded-full border-4 border-white/50 shadow-lg"/>
                        </div>
                        <div class="bg-white p-4 rounded-xl flex items-center justify-center">
                            <canvas id="qr-code"></canvas>
                        </div>
                        <div class="text-center mt-4">
                            <p class="font-semibold">For library, access, and discounts</p>
                            <p id="qr-timer" class="text-sm opacity-80 mt-1">Code refreshes automatically.</p>
                            <button class="mt-2 text-xs font-bold opacity-80 hover:opacity-100" data-action="refresh-qr">Tap to refresh</button>
                        </div>
                        <div class="flex gap-4 mt-6">
                            <button class="flex-1 h-12 bg-black text-white rounded-lg flex items-center justify-center font-semibold text-sm">${createIcon('fa-brands fa-apple', 'mr-2 text-lg')} Add to Apple Wallet</button>
                            <button class="flex-1 h-12 bg-white text-black rounded-lg flex items-center justify-center font-semibold text-sm">${createIcon('fa-brands fa-google-wallet', 'mr-2 text-lg')} Add to Google Wallet</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-2xl shadow-card border border-neutral-200">
                    <div class="w-12 h-12 rounded-xl bg-danger/10 text-danger flex items-center justify-center text-2xl mb-4">${createIcon('fa-solid fa-file-signature')}</div>
                    <h3 class="text-xl font-bold text-neutral-800">Exam Entry</h3>
                    <p class="text-neutral-600 mt-2 text-sm">This digital pass is for all daily campus activities. For high-security exam venues, your simple, physical **University Exam Card** is the only accepted form of ID.</p>
                </div>
                 <div class="bg-white p-6 rounded-2xl shadow-card border border-neutral-200">
                    <div class="w-12 h-12 rounded-xl bg-success/10 text-success flex items-center justify-center text-2xl mb-4">${createIcon('fa-solid fa-wifi')}</div>
                    <h3 class="text-xl font-bold text-neutral-800">Offline Ready</h3>
                    <p class="text-neutral-600 mt-2 text-sm">Your pass works even without an internet connection, ensuring you always have access.</p>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-card border border-neutral-200">
                    <div class="w-12 h-12 rounded-xl bg-warning/10 text-warning flex items-center justify-center text-2xl mb-4">${createIcon('fa-solid fa-user-shield')}</div>
                    <h3 class="text-xl font-bold text-neutral-800">Account Security</h3>
                    <p class="text-neutral-600 mt-2 text-sm">Lost your old device? Secure your account immediately by revoking access.</p>
                    ${createButton({ text: 'Revoke All Other Sessions', action: 'revoke-sessions', variant: 'secondary', size: 'sm', className: 'w-full mt-4', iconLeft: 'fa-solid fa-user-lock' })}
                </div>
            </div>
        </div>
      `;

      // --- NEW: NEXORA DIGITAL CAMPUS HUB VIEW ---
      const renderCampusHubView = () => {
        const createCard = (icon, title, content) => `
            <div class="bg-white p-6 rounded-2xl shadow-card border border-neutral-200">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 rounded-lg bg-primary/10 text-primary flex items-center justify-center mr-4 text-xl">${createIcon(icon)}</div>
                    <h3 class="text-xl font-bold text-neutral-800">${title}</h3>
                </div>
                ${content}
            </div>`;
        
        const courseContent = `<ul class="space-y-3">${constants.campusHub.courses.map(c => `<li class="flex justify-between items-center p-3 rounded-lg hover:bg-neutral-100 cursor-pointer"><span class="font-medium text-neutral-700">${c.name}</span>${c.unread > 0 ? `<span class="text-xs font-bold bg-danger text-white rounded-full w-5 h-5 flex items-center justify-center">${c.unread}</span>` : ''}</li>`).join('')}</ul>`;
        const studyGroupContent = `<ul class="space-y-3">${constants.campusHub.studyGroups.map(sg => `<li class="p-3 rounded-lg hover:bg-neutral-100"><div class="flex justify-between items-center"><span class="font-medium text-neutral-700">${sg.name}</span><span class="text-sm text-neutral-500">${sg.members}/${sg.capacity} Members</span></div></li>`).join('')}</ul><div class="mt-4">${createButton({text: 'Find More Groups', size:'sm', variant:'secondary'})}</div>`;
        const mentorContent = `<ul class="space-y-3">${constants.campusHub.mentors.map(m => `<li class="flex justify-between items-center p-3 rounded-lg hover:bg-neutral-100"><span class="font-medium text-neutral-700">${m.name} <em class="text-sm text-neutral-500 font-normal ml-1">(${m.field})</em></span>${createTag(m.available ? 'Available' : 'Busy', m.available ? 'success' : 'neutral')}</li>`).join('')}</ul><div class="mt-4">${createButton({text: 'Request a Mentor', size:'sm', variant:'secondary'})}</div>`;
        const wellbeingContent = `<p class="text-neutral-600 mb-4 text-sm">A quick check-in can help you stay mindful.</p><div class="flex justify-around">${['ðŸ˜”','ðŸ˜','ðŸ˜Š','ðŸ˜'].map(emoji => `<button class="text-4xl hover:scale-110 transition-transform">${emoji}</button>`).join('')}</div>`;

        return `
            ${createViewHeader('Digital Campus Hub', 'Connect, collaborate, and succeed with your peers.')}
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                ${createCard('fa-solid fa-book', 'My Courses', courseContent)}
                ${createCard('fa-solid fa-user-group', 'Study Groups', studyGroupContent)}
                ${createCard('fa-solid fa-hands-helping', 'Peer Mentorship', mentorContent)}
                ${createCard('fa-solid fa-heart-pulse', 'Well-being Check-in', wellbeingContent)}
            </div>`;
      };
      
      const renderProfileView = () => {
        const { personal, academic, documents, totalCompletion } = state.universalProfile;
        const section = (title, icon, progress, description, action) => `
          <div class="bg-white p-6 rounded-2xl shadow-card border border-neutral-200">
            <div class="flex items-center mb-3">
              <div class="w-10 h-10 rounded-lg bg-primary/10 text-primary flex items-center justify-center mr-4 text-xl">${createIcon(icon)}</div>
              <h3 class="text-xl font-bold text-neutral-800 flex-grow">${title}</h3>
              <span class="font-bold text-primary">${progress}%</span>
            </div>
            ${createProgressBar(progress, 'mb-4')}
            <p class="text-neutral-500 text-sm mb-5">${description}</p>
            ${createButton({text: progress === 100 ? 'View / Edit' : 'Complete Section', variant: progress === 100 ? 'secondary' : 'primary', size: 'sm', action, iconLeft: progress === 100 ? 'fa-solid fa-pen-to-square' : 'fa-solid fa-arrow-right' })}
          </div>`;
        
        return `
            ${createViewHeader('Universal Profile', `Complete these sections once and apply everywhere. Current progress: <strong class="text-primary">${totalCompletion}%</strong>`)}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                ${section('Personal Details', 'fa-solid fa-id-card', personal, 'Provide your basic information, contact details, and next of kin.', 'open-modal:profilePersonal')}
                ${section('Academic History', 'fa-solid fa-graduation-cap', academic, 'Fill in your Grade 11 and 12 results, and previous qualifications.', 'open-modal:profileAcademic')}
                ${section('Documents', 'fa-solid fa-file-arrow-up', documents, 'Upload your certified ID, proof of residence, and academic transcripts.', 'open-modal:profileDocuments')}
            </div>`;
      };
      
      const renderInstitutionCard = (inst) => {
        const isShortlisted = state.shortlist.institutions.has(inst.id);
        return `<div class="bg-white rounded-2xl border-2 ${isShortlisted ? 'border-primary' : 'border-neutral-200'} overflow-hidden transition-all duration-300 group shadow-card hover:shadow-card-hover hover:-translate-y-1 flex flex-col"><div class="p-5 flex flex-col h-full"><div class="flex justify-between items-start mb-4"><div class="w-12 h-12 rounded-xl bg-primary/10 text-primary flex items-center justify-center text-2xl">${createIcon(`fa-solid fa-${inst.logo}`)}</div><button data-action="toggle-shortlist:institutions:${inst.id}" class="w-10 h-10 rounded-full flex items-center justify-center transition-colors ${isShortlisted ? 'text-yellow-400 bg-yellow-400/10' : 'text-neutral-400 hover:bg-neutral-100'}">${createIcon(`fa-${isShortlisted ? 'solid' : 'regular'} fa-star`, 'text-xl')}</button></div><div class="flex-grow"><h3 class="font-bold text-lg text-neutral-800 group-hover:text-primary transition-colors">${inst.name}</h3><p class="text-sm text-neutral-500 flex items-center mt-1">${createIcon('fa-solid fa-location-dot', 'mr-2')} ${inst.location}</p></div><div class="mt-4">${createTag(inst.type, { 'Public University': 'primary', 'TVET College': 'secondary' }[inst.type] || 'neutral')}</div></div></div>`;
      };
      
      const renderFundingCard = (fund) => {
        const isShortlisted = state.shortlist.funding.has(fund.id);
        const tagColors = { "Open": "success", "Closing Soon": "warning", "Closed": "neutral" };
        return `<div class="bg-white rounded-2xl border-2 ${isShortlisted ? 'border-accent' : 'border-neutral-200'} overflow-hidden transition-all duration-300 group shadow-card hover:shadow-card-hover hover:-translate-y-1 flex flex-col"><div class="p-5 flex flex-col h-full"><div class="flex justify-between items-start mb-3"><h3 class="font-bold text-lg text-neutral-800 group-hover:text-accent transition-colors flex-grow pr-4">${fund.name}</h3><button data-action="toggle-shortlist:funding:${fund.id}" class="w-10 h-10 rounded-full flex items-center justify-center transition-colors ${isShortlisted ? 'text-yellow-400 bg-yellow-400/10' : 'text-neutral-400 hover:bg-neutral-100'}">${createIcon(`fa-${isShortlisted ? 'solid' : 'regular'} fa-star`, 'text-xl')}</button></div><p class="text-sm text-neutral-500 font-medium mb-4">${fund.provider}</p><div class="flex-grow space-y-2 text-sm text-neutral-600 mb-4"><p><strong class="font-semibold text-neutral-700">Value:</strong> ${fund.value}</p></div><div class="flex justify-between items-center text-sm">${createTag(fund.status, tagColors[fund.status] || 'neutral')}<span class="text-neutral-500 font-medium">Closes: ${fund.closingDate}</span></div></div></div>`;
      };

      const renderApplyView = () => `
          ${createViewHeader('Find Institutions', 'Search and shortlist institutions for your universal application.')}
          ${createSearchFilterHeader('institutions')}
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            ${constants.allInstitutions.length ? constants.allInstitutions.map(renderInstitutionCard).join('') : createEmptyState('', 'No Institutions Found', 'Please check back later.')}
          </div>`;
      
      const renderFundingView = () => `
          ${createViewHeader('Find Funding', 'Explore bursaries, scholarships, and grants to fund your education.')}
          ${createSearchFilterHeader('funding')}
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${constants.fundingOpportunities.length ? constants.fundingOpportunities.map(renderFundingCard).join('') : createEmptyState('', 'No Funding Found', 'Please check back later.')}
          </div>`;

      const renderShortlistView = () => {
        const instShortlist = [...state.shortlist.institutions].map(id => constants.allInstitutions.find(i => i.id === id));
        const fundShortlist = [...state.shortlist.funding].map(id => constants.fundingOpportunities.find(f => f.id === id));
        return `
          ${createViewHeader('My Shortlist', "Here are the items you've saved. Review them and get ready to apply!")}
          <div class="mb-10">
            <h2 class="text-2xl font-bold text-neutral-800 border-b-2 border-primary pb-2 mb-6">Institutions (${instShortlist.length})</h2>
            ${instShortlist.length ? `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${instShortlist.map(renderInstitutionCard).join('')}</div>` : createEmptyState('', 'No Institutions Shortlisted', 'Browse the Institutions page to add some.')}
          </div>
          <div>
            <h2 class="text-2xl font-bold text-neutral-800 border-b-2 border-accent pb-2 mb-6">Funding (${fundShortlist.length})</h2>
            ${fundShortlist.length > 0 ? `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${fundShortlist.map(renderFundingCard).join('')}</div>` : createEmptyState('', 'No Funding Shortlisted', 'Explore the Funding page to find opportunities.')}
          </div>`;
      };

      const renderAIModal = () => {
        const { messages, isLoading } = state.aiChat;
        return `<div class="flex flex-col h-full">
            <div class="p-4 border-b border-neutral-200 flex justify-between items-center"><h3 class="text-lg font-bold flex items-center">${createIcon('fa-solid fa-robot', 'mr-2 text-primary')} AI Advisor</h3><button data-action="close-modal:aiChat" class="w-8 h-8 rounded-full flex items-center justify-center text-neutral-500 hover:bg-neutral-100">&times;</button></div>
            <div id="ai-chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto custom-scrollbar">${messages.map(msg => `<div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}"><div class="max-w-xs md:max-w-md lg:max-w-lg px-4 py-3 rounded-2xl ${msg.role === 'user' ? 'bg-primary text-white' : 'bg-neutral-200 text-neutral-800'}">${msg.content.replace(/\n/g, '<br>')}</div></div>`).join('')}${isLoading ? `<div class="flex justify-start"><div class="px-4 py-3 rounded-2xl bg-neutral-200 text-neutral-800">Thinking...</div></div>` : ''}</div>
            <div class="p-4 border-t border-neutral-200"><form id="ai-chat-form" class="flex items-center space-x-2"><input id="ai-chat-input" type="text" placeholder="e.g., 'Compare UCT and Wits'" class="form-input" ${isLoading ? 'disabled' : ''}><button type="submit" class="flex-shrink-0 w-10 h-10 bg-primary text-white rounded-lg flex items-center justify-center" ${isLoading ? 'disabled' : ''}>${createIcon('fa-solid fa-paper-plane')}</button></form></div>
          </div>`;
      };

      // --- NEW: Profile Modals ---
      const renderProfileModal = ({ modalId, icon, title, fields, fileFields = [] }) => {
        const fieldHTML = fields.map(f => `<div><label class="form-label" for="${f.id}">${f.label}</label><input type="${f.type || 'text'}" id="${f.id}" value="${f.value || ''}" class="form-input"/></div>`).join('');
        const fileFieldHTML = fileFields.map(f => `
          <div class="p-4 border border-neutral-200 rounded-lg">
            <label class="form-label">${f.label}</label>
            <p class="text-sm text-neutral-500 mb-3">${f.desc}</p>
            <input type="file" id="${f.id}" class="text-sm">
          </div>
        `).join('');

        return `<div class="flex flex-col h-full">
            <div class="p-4 border-b border-neutral-200 flex justify-between items-center flex-shrink-0">
              <h3 class="text-lg font-bold flex items-center">${createIcon(icon, 'mr-2 text-primary')} ${title}</h3>
              <button data-action="close-modal:${modalId}" class="w-8 h-8 rounded-full flex items-center justify-center text-neutral-500 hover:bg-neutral-100">&times;</button>
            </div>
            <div class="flex-grow p-6 overflow-y-auto custom-scrollbar">
              <form id="form-${modalId}" class="space-y-5">
                ${fieldHTML}
                ${fileFieldHTML}
              </form>
            </div>
            <div class="p-4 border-t border-neutral-200 flex-shrink-0 text-right">
              ${createButton({ text: 'Save Changes', action: `save-profile:${modalId}`, iconLeft: 'fa-solid fa-check' })}
            </div>
          </div>`;
      };
      
      // --- LOGIC & EVENT HANDLERS ---
      const handleLogin = (e) => {
        e.preventDefault();
        const email = document.getElementById('email').value;
        state.user = { name: 'Avuyile Mthembu', email, studentNumber: 'ST12345678', university: 'University of South Africa', role: 'Student' };
        // Update profile data from user
        state.universalProfile.data.personal.fullName = state.user.name;
        renderApp();
      };
      
      const handleAction = (action) => {
        if (!action) return;
        const [type, payload, id] = action.split(':');
        
        const actions = {
          'navigate': () => { state.activeView = payload; renderApp(); },
          'toggle-shortlist': () => {
            const set = state.shortlist[payload];
            if (set.has(id)) set.delete(id); else set.add(id);
            renderApp();
          },
          'open-modal': () => { state.modals[payload] = true; renderApp(); },
          'close-modal': () => { state.modals[payload] = false; renderApp(); },
          'refresh-qr': () => {
             state.qrCodeValue = `NEXORA-ID-ST12345678-${Date.now()}`;
             renderApp();
             const timerEl = document.getElementById('qr-timer');
             if(timerEl) {
                 timerEl.textContent = 'Code refreshed!';
                 setTimeout(() => { timerEl.textContent = 'Code refreshes automatically.'; }, 2000);
             }
          },
          'revoke-sessions': () => {
            alert('All other sessions have been revoked. Your account is now secure on this device.');
          },
          'save-profile': () => {
            // In a real app, save form data from document.getElementById(...)
            if (payload === 'profilePersonal') {
              state.universalProfile.data.personal.fullName = document.getElementById('personal-name').value;
              state.universalProfile.data.personal.idNumber = document.getElementById('personal-id').value;
              state.universalProfile.data.personal.phone = document.getElementById('personal-phone').value;
              state.universalProfile.personal = 100;
            }
            if (payload === 'profileAcademic') {
              state.universalProfile.data.academic.school = document.getElementById('academic-school').value;
              state.universalProfile.academic = 50; // Demo progress
            }
            if (payload === 'profileDocuments') {
              state.universalProfile.documents = 25; // Demo progress
            }
            
            // Update checklist
            const profileItem = state.myChecklist.find(i => i.id === 'c1');
            if (profileItem && state.universalProfile.totalCompletion === 100) {
              profileItem.done = true;
            }

            state.modals[payload] = false;
            renderApp();
          }
        };
        if(actions[type]) actions[type]();
      };
      
      const handleSendMessage = (text) => {
        if (!text || state.aiChat.isLoading) return;
        state.aiChat.messages.push({ role: 'user', content: text });
        state.aiChat.isLoading = true;
        renderApp();

        // Simulate AI response
        let response = "This is a simulated AI response. In a real application, this would connect to a powerful language model to provide helpful answers based on your proposal's logic.";
        if (text.toLowerCase().includes('compare uct and wits')) {
          response = "Comparing UCT and Wits:\n\n**University of Cape Town (UCT):**\n* **Strengths:** Strong international ranking, beautiful campus, known for Commerce, Law, and Medicine.\n* **Location:** Cape Town, Western Cape.\n\n**University of the Witwatersrand (Wits):**\n* **Strengths:** Top-tier research output, located in the economic hub of SA, known for Engineering, Science, and Humanities.\n* **Location:** Johannesburg, Gauteng.\n\nBoth are excellent G5 universities. Your choice might depend on your preferred field of study and city."
        } else if (text.toLowerCase().includes('computer science')) {
          response = "**Computer Science (CS)** is the theoretical study of computers and computation. You'll learn about algorithms, data structures, and the 'why' behind software.\n\n**Information Technology (IT)** is more applied. It focuses on using existing computer systems to solve business problems, covering areas like networking, cybersecurity, and system administration.\n\nThink of it this way: A CS graduate builds the engine, while an IT graduate keeps the engine running smoothly for the company."
        }

        setTimeout(() => {
            state.aiChat.isLoading = false;
            state.aiChat.messages.push({ role: 'model', content: response });
            renderApp();
        }, 1200);
      };

      // --- RENDER FUNCTIONS ---
      const postRender = () => {
        if (state.activeView === 'digital-id' && document.getElementById('qr-code')) {
            new QRious({ element: document.getElementById('qr-code'), value: state.qrCodeValue, size: 200, padding: 0 });
        }
        if (state.modals.aiChat) {
            const chatMessages = document.getElementById('ai-chat-messages');
            if(chatMessages) chatMessages.scrollTop = chatMessages.scrollHeight;
        }
      };
      
      const renderApp = () => {
        if (!state.user) {
          appContainer.innerHTML = renderLoginView();
        } else {
            const viewRenderers = {
                dashboard: renderDashboardView,
                'digital-id': renderDigitalIdView,
                'campus-hub': renderCampusHubView,
                profile: renderProfileView,
                apply: renderApplyView,
                funding: renderFundingView,
                shortlist: renderShortlistView,
            };
            const mainContentHTML = viewRenderers[state.activeView] ? viewRenderers[state.activeView]() : `<h2>View not found</h2>`;
            const isOpen = Object.values(state.modals).some(v => v);
            
            document.body.classList.toggle('modal-open', isOpen);

            appContainer.innerHTML = `
                <div class="min-h-screen lg:grid lg:grid-cols-[280px_1fr]">
                  <aside class="hidden lg:flex flex-col bg-white border-r border-neutral-200 p-6">
                    <div class="text-3xl font-extrabold text-neutral-900 mb-10">Nexora<span class="text-primary">.</span></div>
                    <nav class="flex-grow"><ul class="space-y-2">${constants.navItems.map(item => `<li><a href="#" data-action="navigate:${item.id}" class="flex items-center px-4 py-3 rounded-lg font-semibold transition-colors ${state.activeView === item.id ? 'bg-primary/10 text-primary' : 'text-neutral-600 hover:bg-neutral-100'}">${createIcon(item.icon, 'w-6 text-center mr-3')} ${item.label}</a></li>`).join('')}</ul></nav>
                    <div class="border-t border-neutral-200 pt-4"><div class="flex items-center"><img src="https://i.pravatar.cc/40?u=${state.user.email}" class="w-10 h-10 rounded-full mr-3"/><div class="min-w-0"><p class="font-semibold text-neutral-800 truncate">${state.user.name}</p><p class="text-sm text-neutral-500 truncate">${state.user.email}</p></div></div></div>
                  </aside>
                  <main class="bg-neutral-50 p-6 sm:p-8 lg:p-10"><div class="view-content max-w-7xl mx-auto">${mainContentHTML}</div></main>
                </div>

                <nav class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-neutral-200 shadow-[0_-4px_12px_rgba(0,0,0,0.03)] grid grid-cols-5 z-40">
                  ${constants.navItems.filter(i => ['dashboard', 'digital-id', 'campus-hub', 'apply', 'profile'].includes(i.id)).map(item => `
                    <a href="#" data-action="navigate:${item.id}" class="flex flex-col items-center justify-center p-2 text-center ${state.activeView === item.id ? 'text-primary' : 'text-neutral-500'}">
                      ${createIcon(item.icon, 'text-xl')}
                      <span class="text-[10px] font-semibold mt-0.5">${item.label.split(' ')[0]}</span>
                    </a>
                  `).join('')}
                </nav>

                <div class="modal-container fixed inset-0 bg-neutral-900/40 z-50 flex items-center justify-center p-4 ${isOpen ? 'is-open' : ''}">
                    
                    ${state.modals.aiChat ? `<div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-2xl h-[70vh] max-h-[600px] overflow-hidden flex flex-col">${renderAIModal()}</div>` : ''}
                    
                    ${state.modals.profilePersonal ? `<div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-2xl h-auto max-h-[80vh] overflow-hidden flex flex-col">${renderProfileModal({ 
                      modalId: 'profilePersonal', 
                      icon: 'fa-solid fa-id-card', 
                      title: 'Personal Details', 
                      fields: [
                        { id: 'personal-name', label: 'Full Name', value: state.universalProfile.data.personal.fullName },
                        { id: 'personal-id', label: 'SA ID Number', value: state.universalProfile.data.personal.idNumber },
                        { id: 'personal-phone', label: 'Phone Number', value: state.universalProfile.data.personal.phone, type: 'tel' },
                        { id: 'personal-address', label: 'Physical Address', value: '' },
                      ] 
                    })}</div>` : ''}

                    ${state.modals.profileAcademic ? `<div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-2xl h-auto max-h-[80vh] overflow-hidden flex flex-col">${renderProfileModal({ 
                      modalId: 'profileAcademic', 
                      icon: 'fa-solid fa-graduation-cap', 
                      title: 'Academic History', 
                      fields: [
                        { id: 'academic-school', label: 'High School Name', value: state.universalProfile.data.academic.school },
                        { id: 'academic-g11', label: 'Grade 11 Average (%)', value: state.universalProfile.data.academic.grade11Avg, type: 'number' },
                        { id: 'academic-g12', label: 'Grade 12 Average (if available)', value: state.universalProfile.data.academic.grade12Avg, type: 'number' },
                      ] 
                    })}</div>` : ''}

                    ${state.modals.profileDocuments ? `<div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-2xl h-auto max-h-[80vh] overflow-hidden flex flex-col">${renderProfileModal({ 
                      modalId: 'profileDocuments', 
                      icon: 'fa-solid fa-file-arrow-up', 
                      title: 'Document Uploads', 
                      fields: [],
                      fileFields: [
                        { id: 'doc-id', label: 'Certified ID Document', desc: 'Must be certified within the last 3 months. (PDF, JPG, PNG)' },
                        { id: 'doc-proof', label: 'Proof of Residence', desc: 'Utility bill or affidavit. (PDF, JPG, PNG)' },
                        { id: 'doc-results', label: 'Latest Academic Results', desc: 'Grade 11/12 report or transcript. (PDF)' }
                      ]
                    })}</div>` : ''}

                </div>`;
        }
        postRender();
      };

      // --- INITIALIZATION ---
      document.body.addEventListener('click', e => handleAction(e.target.closest('[data-action]')?.dataset.action));
      document.body.addEventListener('submit', e => {
        e.preventDefault();
        if (e.target.id === 'login-form') handleLogin(e);
        if (e.target.id === 'ai-chat-form') {
            const input = document.getElementById('ai-chat-input');
            handleSendMessage(input.value);
            input.value = '';
        }
      });
      renderApp();
    });
  </script>
</body>
</html>
